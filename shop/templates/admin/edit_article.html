{% extends 'admin/layout.html' %}
{% block content %}
{% include 'admin/header.html' %}

<div class="content-wrapper">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Chỉnh sửa bài viết</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{{url_for('admin_manager')}}">Home</a></li>
                        <li class="breadcrumb-item"><a href="{{url_for('articles_manager')}}">Bài viết</a></li>
                        <li class="breadcrumb-item active">Chỉnh sửa</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-12">
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">Chỉnh sửa bài viết: {{ article.title }}</h3>
                        </div>

                        <form method="post" enctype="multipart/form-data">
                            <div class="card-body">
                                {% include '_messages.html' %}

                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="form-group">
                                            <label for="title">Tiêu đề bài viết <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="title" name="title"
                                                   value="{{ article.title }}" placeholder="Nhập tiêu đề bài viết" required>
                                        </div>

                                        <div class="form-group">
                                            <label for="content">Nội dung bài viết <span class="text-danger">*</span></label>
                                            <textarea class="form-control" id="content" name="content" rows="15"
                                                      placeholder="Nhập nội dung bài viết..." required>{{ article.content }}</textarea>
                                        </div>

                                        <div class="form-group">
                                            <label for="status">Trạng thái</label>
                                            <select class="form-control" id="status" name="status">
                                                <option value="draft" {% if article.status == 'draft' %}selected{% endif %}>Bản nháp</option>
                                                <option value="published" {% if article.status == 'published' %}selected{% endif %}>Xuất bản</option>
                                                <option value="archived" {% if article.status == 'archived' %}selected{% endif %}>Lưu trữ</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="form-group">
                                            <label for="cover_image">Ảnh bìa</label>
                                            <div class="custom-file">
                                                <input type="file" class="custom-file-input" id="cover_image"
                                                       name="cover_image" accept="image/*">
                                                <label class="custom-file-label" for="cover_image">
                                                    {% if article.cover_image and article.cover_image != 'article-default.jpg' %}
                                                        {{ article.cover_image }}
                                                    {% else %}
                                                        Chọn ảnh bìa mới
                                                    {% endif %}
                                                </label>
                                            </div>
                                            <small class="form-text text-muted">
                                                Để trống nếu không muốn thay đổi ảnh bìa
                                            </small>
                                        </div>

                                        <div class="form-group">
                                            <label>Xem trước ảnh bìa</label>
                                            <div id="image-preview" class="text-center">
                                                <img id="preview-img" src="{{ url_for('static', filename='images/articles/' + article.cover_image) }}"
                                                     alt="Preview" class="img-fluid rounded" style="max-height: 200px;">
                                            </div>
                                        </div>

                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title">Thông tin bài viết</h5>
                                            </div>
                                            <div class="card-body">
                                                <p><strong>ID:</strong> {{ article.id }}</p>
                                                <p><strong>Người tạo:</strong> {{ article.admin.name }}</p>
                                                <p><strong>Ngày tạo:</strong> {{ article.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                                                <p><strong>Cập nhật:</strong> {{ article.updated_at.strftime('%d/%m/%Y %H:%M') }}</p>
                                                <p><strong>Slug:</strong> <span id="slug-preview">{{ article.slug }}</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card-footer">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Cập nhật bài viết
                                </button>
                                <a href="{{ url_for('articles_manager') }}" class="btn btn-secondary ml-2">
                                    <i class="fas fa-times"></i> Hủy
                                </a>
                                <div class="float-right">
                                    <span class="badge badge-info">{{ article.status.title() }}</span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
// Update slug preview when title changes
document.getElementById('title').addEventListener('input', function() {
    const title = this.value;
    const slug = title.toLowerCase()
        .replace(/[^\w\s-]/g, '')
        .replace(/[\s_-]+/g, '-')
        .replace(/^-+|-+$/g, '');
    document.getElementById('slug-preview').textContent = slug || '-';
});

// Image preview
document.getElementById('cover_image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-img').src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// Update file label
document.querySelector('.custom-file-input').addEventListener('change', function(e) {
    const fileName = e.target.files[0]?.name || 'Chọn ảnh bìa mới';
    const label = e.target.nextElementSibling;
    label.textContent = fileName;
});
</script>

<style>
.custom-file-label {
    overflow: hidden;
}

.custom-file-label::after {
    content: "Browse";
}
</style>

{% include 'admin/footer.html' %}
{% endblock %}
