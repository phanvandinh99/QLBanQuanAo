{% extends "admin/layout.html" %}
{% block content %}

<style>
.admin-order-container {
    background: #f8f9fa;
    min-height: 100vh;
    padding: 20px 0;
}

.order-header {
    background: white;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.order-header h2 {
    color: #2c3e50;
    margin-bottom: 10px;
    font-weight: 600;
}

.product-selection {
    background: white;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.cart-section {
    background: white;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.customer-info {
    background: white;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2c3e50;
    font-size: 14px;
}

.form-control {
    width: 100%;
    padding: 10px 15px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
    color: white;
    transform: translateY(-1px);
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #1e7e34;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #bd2130;
    color: white;
}

.btn-warning {
    background: #ffc107;
    color: #212529;
}

.btn-warning:hover {
    background: #e0a800;
    color: #212529;
}

.table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
}

.table th, .table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.cart-item {
    border-bottom: 1px solid #e9ecef;
    padding: 15px 0;
}

.cart-item:last-child {
    border-bottom: none;
}

.cart-total {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
}

.cart-total h4 {
    margin-bottom: 15px;
    color: #2c3e50;
    font-weight: 600;
}

.total-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 16px;
}

.total-row.final {
    font-size: 18px;
    font-weight: 600;
    color: #28a745;
    border-top: 2px solid #dee2e6;
    padding-top: 10px;
}

.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}

.radio-option {
    display: flex;
    align-items: center;
    cursor: pointer;
}

.radio-option input[type="radio"] {
    margin-right: 8px;
    transform: scale(1.2);
    accent-color: #007bff;
}

.radio-option label {
    font-weight: 500;
    cursor: pointer;
}

.product-select {
    width: 100%;
    padding: 10px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
}

.alert {
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    border: 1px solid transparent;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border-color: #c3e6cb;
}

.alert-danger {
    background: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
}

.alert-info {
    background: #d1ecf1;
    color: #0c5460;
    border-color: #bee5eb;
}

.empty-cart {
    text-align: center;
    padding: 40px;
    color: #6c757d;
}

.empty-cart i {
    font-size: 48px;
    margin-bottom: 15px;
    display: block;
}

@media (max-width: 768px) {
    .admin-order-container {
        padding: 10px;
    }

    .order-header, .product-selection, .cart-section, .customer-info {
        padding: 15px;
    }

    .radio-group {
        flex-direction: column;
        gap: 10px;
    }

    .table {
        font-size: 14px;
    }

    .table th, .table td {
        padding: 8px;
    }
}
</style>

<div class="admin-order-container">
    <div class="container-fluid">
        <!-- Header -->
        <div class="order-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fa fa-shopping-cart"></i> Tạo Đơn Hàng Tại Quầy</h2>
                    <p class="mb-0 text-muted">Quản lý đơn hàng bán tại cửa hàng</p>
                </div>
                <div>
                    <a href="{{ url_for('orders_manager') }}" class="btn btn-outline-secondary">
                        <i class="fa fa-arrow-left"></i> Quay lại
                    </a>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column -->
            <div class="col-lg-8">
                <!-- Product Selection -->
                <div class="product-selection">
                    <h4><i class="fa fa-plus-circle"></i> Thêm Sản Phẩm</h4>
                    <form method="POST" action="{{ url_for('admin_create_order') }}">
                        {{ item_form.hidden_tag() }}
                        <input type="hidden" name="add_item" value="1">

                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">Chọn Sản Phẩm</label>
                                    <select name="product_id" class="product-select" required>
                                        <option value="">-- Chọn sản phẩm --</option>
                                        {% for product in products %}
                                        <option value="{{ product.id }}">
                                            {{ product.name }} ({{ product.price | vnd }}) - Còn {{ product.stock }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="form-label">Số Lượng</label>
                                    <input type="number" name="quantity" class="form-control" min="1" value="1" required>
                                </div>
                            </div>

                            <div class="col-md-2">
                                <div class="form-group">
                                    <label class="form-label">Giảm Giá (%)</label>
                                    <input type="number" name="discount" class="form-control" min="0" max="100" value="0">
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="fa fa-plus"></i> Thêm Vào Đơn
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Shopping Cart -->
                <div class="cart-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="fa fa-shopping-cart"></i> Giỏ Hàng ({{ total_quantity }} sản phẩm)</h4>
                        {% if admin_cart %}
                        <a href="{{ url_for('admin_clear_cart') }}" class="btn btn-sm btn-outline-danger"
                           onclick="return confirm('Bạn có chắc muốn xóa toàn bộ giỏ hàng?')">
                            <i class="fa fa-trash"></i> Xóa Tất Cả
                        </a>
                        {% endif %}
                    </div>

                    {% if cart_items %}
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Sản Phẩm</th>
                                    <th class="text-center">SL</th>
                                    <th class="text-right">Đơn Giá</th>
                                    <th class="text-center">Giảm</th>
                                    <th class="text-right">Thành Tiền</th>
                                    <th class="text-center">Thao Tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cart_items %}
                                <tr>
                                    <td>
                                        <strong>{{ item.product.name }}</strong>
                                        <br><small class="text-muted">{{ item.product.brand.name if item.product.brand else '' }}</small>
                                    </td>
                                    <td class="text-center">{{ item.quantity }}</td>
                                    <td class="text-right">{{ item.unit_price | vnd }}</td>
                                    <td class="text-center">{{ item.discount_percent }}%</td>
                                    <td class="text-right">
                                        <strong>{{ item.final_price | vnd }}</strong>
                                        {% if item.discount_amount > 0 %}
                                        <br><small class="text-muted">Tiết kiệm: {{ item.discount_amount | vnd }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <form method="POST" action="{{ url_for('admin_create_order') }}" style="display: inline;">
                                            <input type="hidden" name="remove_item" value="1">
                                            <input type="hidden" name="product_id" value="{{ item.product.id }}">
                                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('Xóa sản phẩm này khỏi giỏ hàng?')">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Cart Total -->
                    <div class="cart-total">
                        <div class="total-row">
                            <span>Tạm Tính:</span>
                            <span>{{ subtotal | vnd }}</span>
                        </div>
                        {% if total_discount > 0 %}
                        <div class="total-row">
                            <span>Giảm Giá:</span>
                            <span class="text-success">-{{ total_discount | vnd }}</span>
                        </div>
                        {% endif %}
                        <div class="total-row final">
                            <span>Tổng Cộng:</span>
                            <span>{{ total_amount | vnd }}</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-cart">
                        <i class="fa fa-shopping-cart"></i>
                        <p>Chưa có sản phẩm nào trong giỏ hàng</p>
                        <small class="text-muted">Hãy chọn sản phẩm để thêm vào đơn hàng</small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-lg-4">
                <!-- Customer Information -->
                <div class="customer-info">
                    <h4><i class="fa fa-user"></i> Thông Tin Khách Hàng</h4>

                    {% if cart_items %}
                    <form method="POST" action="{{ url_for('admin_create_order') }}">
                        {{ form.hidden_tag() }}
                        <input type="hidden" name="create_order" value="1">

                        <!-- Phone Number Check Section -->
                        <div class="phone-check-section">
                            <div class="form-group">
                                <label class="form-label">Số Điện Thoại Khách Hàng *</label>
                                <div class="input-group">
                                    <input type="tel" name="customer_phone" class="form-control"
                                           id="customerPhone" placeholder="0987654321" required
                                           value="{{ form.customer_phone.data or '' }}">
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-outline-primary" id="checkPhoneBtn">
                                            <i class="fas fa-search"></i> Kiểm tra
                                        </button>
                                    </div>
                                </div>
                                {% if form.customer_phone.errors %}
                                <div class="text-danger">
                                    {% for error in form.customer_phone.errors %}
                                    <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <small class="form-text text-muted">Nhập số điện thoại để kiểm tra thông tin khách hàng</small>
                            </div>

                            <!-- Loading indicator -->
                            <div id="phoneCheckLoading" class="text-center" style="display: none;">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="sr-only">Đang kiểm tra...</span>
                                </div>
                                <small class="text-muted ml-2">Đang kiểm tra...</small>
                            </div>

                            <!-- Check result -->
                            <div id="phoneCheckResult" class="alert" style="display: none;"></div>
                        </div>

                        <!-- Customer Info Section (shown when phone is checked) -->
                        <div id="customerInfoSection" style="display: none;">
                            <!-- Existing Customer Info -->
                            <div id="existingCustomerInfo" style="display: none;">
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <strong>Khách hàng đã tồn tại!</strong>
                                    <p class="mb-2">Đã tìm thấy thông tin khách hàng với số điện thoại này.</p>
                                    <button type="button" class="btn btn-sm btn-outline-success" id="useExistingInfo">
                                        <i class="fas fa-check mr-1"></i>Sử dụng thông tin này
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-warning" id="editCustomerInfo">
                                        <i class="fas fa-edit mr-1"></i>Chỉnh sửa thông tin
                                    </button>
                                </div>

                                <div id="existingCustomerDetails" class="border rounded p-3 bg-light">
                                    <!-- Customer details will be populated by JavaScript -->
                                </div>
                            </div>

                            <!-- New Customer Form -->
                            <div id="newCustomerForm">
                                <div class="alert alert-info">
                                    <i class="fas fa-user-plus mr-2"></i>
                                    <strong>Khách hàng mới</strong>
                                    <p class="mb-0">Vui lòng nhập thông tin khách hàng để tạo tài khoản mới.</p>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Họ Tên Khách Hàng *</label>
                                    <input type="text" name="customer_name" class="form-control"
                                           id="customerName" placeholder="Nguyễn Văn A"
                                           value="{{ form.customer_name.data or '' }}">
                                    {% if form.customer_name.errors %}
                                    <div class="text-danger">
                                        {% for error in form.customer_name.errors %}
                                        <small>{{ error }}</small><br>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Email Khách Hàng</label>
                                    <input type="email" name="customer_email" class="form-control"
                                           id="customerEmail" placeholder="email@example.com"
                                           value="{{ form.customer_email.data or '' }}">
                                    {% if form.customer_email.errors %}
                                    <div class="text-danger">
                                        {% for error in form.customer_email.errors %}
                                        <small>{{ error }}</small><br>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Không bắt buộc, dùng để gửi thông tin đơn hàng</small>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Phương Thức Thanh Toán *</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" name="payment_method" value="cash" id="cash" required
                                           {% if form.payment_method.data == 'cash' or not form.payment_method.data %}checked{% endif %}>
                                    <label for="cash">
                                        <i class="fa fa-money"></i> Tiền Mặt
                                    </label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" name="payment_method" value="qr_code" id="qr_code" required
                                           {% if form.payment_method.data == 'qr_code' %}checked{% endif %}>
                                    <label for="qr_code">
                                        <i class="fa fa-qrcode"></i> QR Code
                                    </label>
                                </div>
                            </div>
                            {% if form.payment_method.errors %}
                            <div class="text-danger">
                                {% for error in form.payment_method.errors %}
                                <small>{{ error }}</small><br>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label class="form-label">Ghi Chú Đơn Hàng</label>
                            <textarea name="notes" class="form-control" rows="3"
                                      placeholder="Ghi chú đặc biệt về đơn hàng...">{{ form.notes.data or '' }}</textarea>
                            {% if form.notes.errors %}
                            <div class="text-danger">
                                {% for error in form.notes.errors %}
                                <small>{{ error }}</small><br>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fa fa-check"></i> Tạo Đơn Hàng
                            </button>
                        </div>
                    </form>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"></i>
                        <strong>Thông Tin:</strong> Hãy thêm sản phẩm vào giỏ hàng trước khi tạo đơn hàng.
                    </div>
                    {% endif %}
                </div>

                <!-- Quick Actions -->
                <div class="customer-info">
                    <h4><i class="fa fa-cogs"></i> Thao Tác Nhanh</h4>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('orders_manager') }}" class="btn btn-outline-primary">
                            <i class="fa fa-list"></i> Quản Lý Đơn Hàng
                        </a>
                        <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary">
                            <i class="fa fa-home"></i> Trang Chủ Admin
                        </a>
                        {% if admin_cart %}
                        <a href="{{ url_for('admin_clear_cart') }}" class="btn btn-outline-warning"
                           onclick="return confirm('Xóa toàn bộ giỏ hàng?')">
                            <i class="fa fa-trash"></i> Xóa Giỏ Hàng
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- This script content has been moved to extra_scripts block -->

{% endblock %}

{% block extra_scripts %}
<script>

// Debug function (no-op for production)
function debugLog(message, data = null) {
    // Removed for production - was used for debugging
}

// Check DOM elements
document.addEventListener('DOMContentLoaded', function() {
});

// Initialize everything when jQuery is available
function initializeWhenJQueryReady() {
    if (typeof $ === 'undefined') {
        setTimeout(initializeWhenJQueryReady, 100);
        return;
    }


    // Use jQuery for complex operations
    $(document).ready(function() {

        // Check button with jQuery - use actual functionality
        $('#checkPhoneBtn').on('click', function(e) {
            e.preventDefault();
            checkCustomerPhoneNumber();
        });

        // Test phone input with jQuery
        $('#customerPhone').on('input', function() {
            var phoneValue = $(this).val();
        });

        // Form validation - only validate customer name when form section is visible
        $('#orderForm').on('submit', function(e) {
            debugLog('Form submit triggered');

            // Only validate customer name if customer info section is visible
            const customerInfoVisible = $('#customerInfoSection').is(':visible');
            const customerNameValue = $('#customerName').val().trim();

            debugLog('Customer info visible:', customerInfoVisible);
            debugLog('Customer name value:', customerNameValue);

            if (customerInfoVisible && !customerNameValue) {
                e.preventDefault();
                alert('Vui lòng nhập họ tên khách hàng!');
                $('#customerName').focus();
                return false;
            }

            if (!confirm('Bạn có chắc muốn tạo đơn hàng này?')) {
                e.preventDefault();
                return false;
            }
        });

        // Real-time validation for customer name (only when visible)
        $('#customerName').on('input', function() {
            const name = $(this).val().trim();
            const customerInfoVisible = $('#customerInfoSection').is(':visible');

            if (customerInfoVisible) {
                if (name.length < 2) {
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid');
                }
            }
        });

        // Email validation
        $('#customerEmail').on('input', function() {
            const email = $(this).val().trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (email && !emailRegex.test(email)) {
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });

        debugLog('jQuery event listeners attached successfully');
    });
}

// Also try with vanilla JavaScript immediately
function initializeWithVanillaJS() {
    debugLog('Initializing with vanilla JavaScript...');
    debugLog('Function initializeWithVanillaJS called successfully');

    // Test check button with vanilla JS
    var checkBtn = document.getElementById('checkPhoneBtn');
    if (checkBtn) {
        checkBtn.addEventListener('click', function(e) {
            e.preventDefault();
            debugLog('Vanilla JS check button clicked!');
            checkCustomerPhoneNumber();
        });
        debugLog('Vanilla JS check button listener attached');
    } else {
        debugLog('Vanilla JS check button not found!');
    }

    // Log initialization status
    debugLog('Vanilla JS initialization completed');

    // Test phone input with vanilla JS
    var phoneInput = document.getElementById('customerPhone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function() {
            debugLog('Vanilla JS phone input changed:', this.value);
        });
        debugLog('Vanilla JS phone input listener attached');
    } else {
        debugLog('Vanilla JS phone input not found!');
    }

    // Form validation with vanilla JS
    var orderForm = document.getElementById('orderForm');
    if (orderForm) {
        orderForm.addEventListener('submit', function(e) {
            debugLog('Vanilla JS form submit triggered');

            var customerInfoSection = document.getElementById('customerInfoSection');
            var customerNameInput = document.getElementById('customerName');

            if (customerInfoSection && customerNameInput) {
                var customerInfoVisible = customerInfoSection.style.display !== 'none';
                var customerNameValue = customerNameInput.value.trim();

                debugLog('Vanilla JS customer info visible:', customerInfoVisible);
                debugLog('Vanilla JS customer name value:', customerNameValue);

                if (customerInfoVisible && !customerNameValue) {
                    e.preventDefault();
                    alert('Vui lòng nhập họ tên khách hàng!');
                    customerNameInput.focus();
                    return false;
                }
            }

            if (!confirm('Bạn có chắc muốn tạo đơn hàng này?')) {
                e.preventDefault();
                return false;
            }
        });
        debugLog('Vanilla JS form validation attached');
    }

    // Customer name validation with vanilla JS
    var customerNameInput = document.getElementById('customerName');
    if (customerNameInput) {
        customerNameInput.addEventListener('input', function() {
            var customerInfoSection = document.getElementById('customerInfoSection');
            if (customerInfoSection && customerInfoSection.style.display !== 'none') {
                var name = this.value.trim();
                if (name.length < 2) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            }
        });
        debugLog('Vanilla JS customer name validation attached');
    }

    // Email validation with vanilla JS
    var customerEmailInput = document.getElementById('customerEmail');
    if (customerEmailInput) {
        customerEmailInput.addEventListener('input', function() {
            var email = this.value.trim();
            var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (email && !emailRegex.test(email)) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
        debugLog('Vanilla JS email validation attached');
    }
}

// Initialize immediately with vanilla JS
debugLog('Script loaded, starting initialization...');
debugLog('Calling initializeWithVanillaJS...');
initializeWithVanillaJS();
debugLog('initializeWithVanillaJS completed');

// Try to initialize with jQuery when it's ready
initializeWhenJQueryReady();

// Also try on window load as final fallback
window.addEventListener('load', function() {
    debugLog('Window load event triggered');
    initializeWhenJQueryReady(); // Try jQuery again
});

debugLog('Initialization setup complete');

// Function to check customer phone number
function checkCustomerPhoneNumber() {
    const phoneInput = document.getElementById('customerPhone');
    const checkBtn = document.getElementById('checkPhoneBtn');
    const loadingDiv = document.getElementById('phoneCheckLoading');
    const resultDiv = document.getElementById('phoneCheckResult');

    const phoneNumber = phoneInput ? phoneInput.value.trim() : '';
    const csrfToken = getCSRFToken();

    if (!phoneNumber) {
        showResult('Vui lòng nhập số điện thoại', 'warning');
        return;
    }

    if (phoneNumber.length < 10 || phoneNumber.length > 15) {
        showResult('Số điện thoại phải từ 10-15 ký tự', 'warning');
        return;
    }

    // Show loading
    if (checkBtn) checkBtn.disabled = true;
    if (checkBtn) checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    if (loadingDiv) loadingDiv.style.display = 'block';
    if (resultDiv) resultDiv.style.display = 'none';

    // Make API call
    fetch('/admin/api/check-customer-phone', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ phone_number: phoneNumber })
    })
    .then(response => {
        debugLog('API response status:', response.status);
        debugLog('API response headers:', response.headers.get('content-type'));

        // Check if response is HTML (error page) instead of JSON
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            debugLog('Received HTML response instead of JSON');
            return response.text().then(html => {
                debugLog('HTML response preview:', html.substring(0, 200));
                throw new Error('Server returned HTML instead of JSON. Check if you are logged in.');
            });
        }

        return response.json().then(data => {
            if (!response.ok) {
                debugLog('API returned error status with data:', data);
                throw new Error(data.error || `HTTP ${response.status}`);
            }
            debugLog('API returned success data:', data);
            return data;
        });
    })
    .then(data => {
        debugLog('API success response:', data);

        if (data.exists) {
            showExistingCustomerInfo(data.customer);
            showResult('Đã tìm thấy thông tin khách hàng!', 'success');
        } else {
            showNewCustomerForm();
            showResult(data.message, 'info');
        }
    })
    .catch(error => {
        debugLog('API error:', error);
        let errorMessage = 'Có lỗi xảy ra khi kiểm tra số điện thoại';

        if (error.message.includes('401')) {
            errorMessage = 'Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.';
            // Redirect to login page after a short delay
            setTimeout(() => {
                window.location.href = '/admin/login';
            }, 2000);
        } else if (error.message.includes('403')) {
            errorMessage = 'Bạn không có quyền thực hiện hành động này.';
        } else if (error.message.includes('500')) {
            errorMessage = 'Lỗi máy chủ. Vui lòng thử lại sau.';
        } else if (error.message) {
            errorMessage = error.message;
        }

        showResult(errorMessage, 'danger');
        hideCustomerInfo();
    })
    .finally(() => {
        // Hide loading
        if (checkBtn) checkBtn.disabled = false;
        if (checkBtn) checkBtn.innerHTML = '<i class="fas fa-search"></i> Kiểm tra';
        if (loadingDiv) loadingDiv.style.display = 'none';
    });
}

// Function to get CSRF token
function getCSRFToken() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    return csrfToken ? csrfToken.getAttribute('content') : '';
}

// Function to show result message
function showResult(message, type) {
    const resultDiv = document.getElementById('phoneCheckResult');
    if (!resultDiv) return;

    resultDiv.className = `alert alert-${type}`;
    resultDiv.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
    resultDiv.style.display = 'block';
}

// Function to hide customer info sections
function hideCustomerInfo() {
    const infoSection = document.getElementById('customerInfoSection');
    const existingInfo = document.getElementById('existingCustomerInfo');
    const newForm = document.getElementById('newCustomerForm');

    if (infoSection) infoSection.style.display = 'none';
    if (existingInfo) existingInfo.style.display = 'none';
    if (newForm) newForm.style.display = 'none';
}

// Function to show existing customer information
function showExistingCustomerInfo(customer) {
    const infoSection = document.getElementById('customerInfoSection');
    const existingInfo = document.getElementById('existingCustomerInfo');
    const newForm = document.getElementById('newCustomerForm');
    const detailsDiv = document.getElementById('existingCustomerDetails');

    if (infoSection) infoSection.style.display = 'block';
    if (existingInfo) existingInfo.style.display = 'block';
    if (newForm) newForm.style.display = 'none';

    if (detailsDiv) {
        detailsDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <strong>Họ tên:</strong> ${customer.full_name}
                </div>
                <div class="col-md-6">
                    <strong>Số điện thoại:</strong> ${customer.phone_number}
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <strong>Email:</strong> ${customer.email || 'Chưa cập nhật'}
                </div>
                <div class="col-md-6">
                    <strong>Trạng thái:</strong>
                    <span class="badge badge-${customer.is_active ? 'success' : 'secondary'}">
                        ${customer.is_active ? 'Hoạt động' : 'Không hoạt động'}
                    </span>
                </div>
            </div>
        `;
    }

    // Set form values
    const nameInput = document.getElementById('customerName');
    const emailInput = document.getElementById('customerEmail');

    if (nameInput) nameInput.value = customer.full_name;
    if (emailInput) emailInput.value = customer.email || '';
}

// Function to show new customer form
function showNewCustomerForm() {
    const infoSection = document.getElementById('customerInfoSection');
    const existingInfo = document.getElementById('existingCustomerInfo');
    const newForm = document.getElementById('newCustomerForm');

    if (infoSection) infoSection.style.display = 'block';
    if (existingInfo) existingInfo.style.display = 'none';
    if (newForm) newForm.style.display = 'block';

    // Clear form
    const nameInput = document.getElementById('customerName');
    const emailInput = document.getElementById('customerEmail');

    if (nameInput) nameInput.value = '';
    if (emailInput) emailInput.value = '';
}

debugLog('Customer phone check functions loaded - Test button removed');
</script>
{% endblock %}
