{% extends "base.html" %} {%block content%} {% include 'header.html' %}
<div class="single-page">
  <div class="container">
    <!-- Breadcrumb -->
    <div class="row">
      <div class="col-lg-12">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="{{url_for('home')}}">Trang chủ</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Giỏ hàng & Thanh toán</li>
          </ol>
        </nav>
      </div>
    </div>

    {% if empty %}
    <!-- Empty Cart -->
    <div class="row justify-content-center">
      <div class="col-md-8">
        <div class="card shadow-sm border-0">
          <div class="card-body text-center py-5">
            <div class="mb-4">
              <i
                class="fa fa-shopping-cart"
                style="font-size: 4rem; color: #6c757d"
              ></i>
            </div>
            <h3 class="text-muted mb-3">Giỏ hàng trống</h3>
            <p class="text-muted mb-4">
              Bạn chưa có sản phẩm nào trong giỏ hàng
            </p>
            <a href="{{url_for('home')}}" class="btn btn-primary btn-lg">
              <i class="fa fa-shopping-bag me-2"></i>Tiếp tục mua sắm
            </a>
          </div>
        </div>
      </div>
    </div>
    {% else %}
    <!-- Cart Items -->
    <div class="row">
      <div class="col-lg-8">
        <div class="card shadow border-0 mb-4">
          <div
            class="card-header text-white border-0 py-3"
            style="background-color: #0cafe5"
          >
            <h4 class="mb-0">
              <i class="fa fa-shopping-cart me-2"></i> Giỏ hàng của bạn
            </h4>
          </div>
          <div class="card-body p-0">
            {% for key, product in session['Shoppingcart'].items() %} {% set
            discount =(product.discount/100) * product.price|float %}
            <div class="cart-item border-bottom p-4">
              <div class="row align-items-center">
                <!-- Product Image -->
                <div class="col-md-2 col-sm-3">
                  <div class="product-image-wrapper">
                    <img
                      src="{{url_for('static',filename='images/'+ product.image)}}"
                      alt="{{product.name}}"
                      class="img-fluid rounded shadow-sm"
                      style="max-height: 100px; object-fit: cover; width: 100%"
                    />
                  </div>
                </div>

                <!-- Product Details -->
                <div class="col-md-7 col-sm-9">
                  <div class="product-details">
                    <h3 class="product-title mb-2">
                      <a
                        href="{{url_for('detail', id = key)}}"
                        class="text-decoration-none text-dark"
                      >
                        {{product.name}}
                      </a>
                    </h3>
                    <p class="text-muted mb-3">
                      <i class="fa fa-tag me-1"></i> {{ product.brand }}
                    </p>

                    <!-- Color Selection -->
                    <form
                      action="{{url_for('updatecart', code=key)}}"
                      method="post"
                      class="mb-3"
                    >
                      <div
                        style="display: flex; align-items: center; width: 100%"
                      >
                        <div
                          style="
                            display: flex;
                            align-items: center;
                            margin-right: 25px;
                          "
                        >
                          <span
                            class="small text-muted"
                            style="margin-right: 8px; white-space: nowrap"
                            >Màu sắc:</span
                          >
                          {% set colors = product.colors.split(',') %}
                          <select
                            name="color"
                            id="color"
                            class="form-select form-select-sm"
                            style="width: 100px"
                          >
                            <option value="{{product.color}}">
                              {{product.color|capitalize}}
                            </option>
                            {% for color in colors %} {% set col =
                            color.split(':') %}
                            <option value="{{col[0]}}">
                              {{col[0] | capitalize }}
                            </option>
                            {% endfor %}
                          </select>
                        </div>
                        <div
                          style="
                            display: flex;
                            align-items: center;
                            margin-right: 25px;
                          "
                        >
                          <span
                            class="small text-muted"
                            style="margin-right: 8px; white-space: nowrap"
                            >Số lượng:</span
                          >
                          <input
                            type="number"
                            name="quantity"
                            min="1"
                            max="10"
                            value="{{product.quantity}}"
                            class="form-control form-select-sm"
                            style="
                              width: 60px;
                              height: 32px;
                              font-size: 0.875rem;
                            "
                          />
                        </div>
                        <div
                          style="
                            display: flex;
                            align-items: center;
                            margin-right: 15px;
                          "
                        >
                          <button
                            class="btn btn-outline-primary btn-sm"
                            type="submit"
                            style="
                              height: 32px;
                              width: 32px;
                              display: flex;
                              align-items: center;
                              justify-content: center;
                              padding: 0;
                            "
                          >
                            <i class="fa fa-refresh" style="margin: 0"></i>
                          </button>
                        </div>
                        <div style="margin-left: auto">
                          <a
                            href="{{url_for('deleteitem', id=key)}}"
                            class="btn btn-outline-danger btn-sm"
                            style="
                              height: 32px;
                              width: 32px;
                              display: flex;
                              align-items: center;
                              justify-content: center;
                              padding: 0;
                            "
                            onclick="return confirm('Bạn có chắc muốn xóa sản phẩm này?')"
                          >
                            <i class="fa fa-trash" style="margin: 0"></i>
                          </a>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>

                <!-- Price Display -->
                <div class="col-md-3 col-sm-12">
                  <div class="text-end">
                    <div class="price-section">
                      {% if product.discount %}
                      <div class="current-price fw-bold text-primary fs-4">
                        Giá bán: {{(product.price - discount) | vnd}}
                      </div>
                      <div
                        class="original-price text-muted text-decoration-line-through small"
                      >
                        Giá gốc: {{product.price | vnd}}
                      </div>
                      <span class="badge bg-danger ms-2"
                        >-{{product.discount}}%</span
                      >
                      {% else %}
                      <div class="current-price fw-bold text-primary fs-4">
                        {{product.price | vnd}}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- Clear Cart Button -->
        <div class="text-end mb-4">
          <a
            href="{{url_for('clearcart')}}"
            class="btn btn-outline-danger"
            onclick="return confirm('Bạn có chắc muốn xóa tất cả sản phẩm?')"
          >
            <i class="fa fa-trash me-2"></i> Xóa tất cả
          </a>
        </div>
      </div>

      <!-- Order Summary & Payment -->
      <div class="col-lg-4">
        <div class="card shadow border-0 sticky-top" style="top: 20px">
          <div
            class="card-header text-white py-3"
            style="background-color: #0cafe5"
          >
            <h4 class="mb-0">
              <i class="fa fa-credit-card me-2"></i> Thanh toán
            </h4>
          </div>
          <div class="card-body p-4" style="padding-left: 8px !important; padding-right: 8px !important;">
            <!-- Order Summary -->
            <div class="mb-4">
              <div
                class="summary-item d-flex justify-content-between mb-2 p-3 bg-light rounded"
              >
                <span class="text-muted">Tạm tính:</span>
                <span class="fw-bold">{{subtotals | vnd}}</span>
              </div>
              <div
                class="summary-item d-flex justify-content-between mb-3 p-3 bg-light rounded"
              >
                <span class="text-muted">Giảm giá:</span>
                <span class="text-success fw-bold">-{{discounttotal | vnd}}</span>
              </div>

              <div
                class="summary-item d-flex justify-content-between mb-4 p-3 bg-primary text-white rounded"
              >
                <span class="fw-bold">Tổng cộng:</span>
                <span class="fw-bold">{{(subtotals-discounttotal) | vnd}}</span>
              </div>
            </div>

            <!-- Customer Information -->
            <div class="mb-4">
              
                             <div class="mb-2 d-flex align-items-center">
                 <label class="form-label fw-bold me-2" style="font-size: 13px; margin-bottom: 0; min-width: 80px;">Họ tên:</label>
                 <input type="text" class="form-control" id="customer_name" 
                        value="{{current_user.username if current_user.is_authenticated else ''}}" readonly>
               </div>
               
               <div class="mb-2 d-flex align-items-center">
                 <label class="form-label fw-bold me-2" style="font-size: 13px; margin-bottom: 0; min-width: 80px;">Email:</label>
                 <input type="email" class="form-control" id="customer_email" 
                        value="{{current_user.email if current_user.is_authenticated else ''}}" readonly>
               </div>
               
               <div class="mb-2 d-flex align-items-center">
                 <label class="form-label fw-bold me-2" style="font-size: 13px; margin-bottom: 0; min-width: 80px;">Số điện thoại:</label>
                 <input type="text" class="form-control" id="customer_phone" 
                        value="{{current_user.phone_number if current_user.is_authenticated else ''}}" readonly>
               </div>
              
                             <div class="mb-3">
                 <label class="form-label fw-bold" style="font-size: 14px; margin-bottom: 4px;">Địa chỉ giao hàng: <span class="text-danger">*</span></label>
                 <textarea class="form-control" id="customer_address" 
                           placeholder="Nhập địa chỉ giao hàng" required
                           style="min-height: 50px; resize: vertical;"></textarea>
               </div>
            </div>

                         <!-- Payment Methods -->
             <div class="mb-4">
               <h5 class="mb-3">Phương thức thanh toán</h5>
               
               <div class="mb-2">
                 <div class="form-check">
                   <input class="form-check-input" type="radio" name="payment_method" id="cod" value="cod" checked>
                   <label class="form-check-label" for="cod" style="font-size: 14px;">
                     <i class="fa fa-money me-2"></i>Thanh toán khi nhận hàng
                   </label>
                 </div>
               </div>

               <div class="mb-2">
                 <div class="form-check">
                   <input class="form-check-input" type="radio" name="payment_method" id="vnpay" value="vnpay">
                   <label class="form-check-label" for="vnpay" style="font-size: 14px;">
                     <i class="fa fa-credit-card me-2"></i>Thanh toán VNPAY
                   </label>
                 </div>
               </div>
             </div>

            <!-- Place Order Button -->
            <div class="mb-4 text-center">
              <button class="btn btn-success" onclick="placeOrder()" 
                      style="width: auto; min-width: 200px; padding: 10px 30px;">
                <i class="fa fa-credit-card me-2"></i>Đặt hàng
              </button>
            </div>

            <!-- Continue Shopping -->
            <div class="text-center">
              <a
                href="{{url_for('home')}}"
                class="text-decoration-none text-muted"
              >
                <i class="fa fa-arrow-left me-1"></i>Tiếp tục mua sắm
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden form for order submission -->
    <form id="orderForm" action="{{ url_for('submit_order') }}" method="POST" style="display: none;">
      <input type="hidden" name="CustomerName" id="form_customer_name">
      <input type="hidden" name="CustomerEmail" id="form_customer_email">
      <input type="hidden" name="CustomerPhone" id="form_customer_phone">
      <input type="hidden" name="CustomerAddress" id="form_customer_address">
      <input type="hidden" name="payment_method" id="form_payment_method">
      <input type="hidden" name="invoice_customer" value="{{','.join(invoices) if invoices else ''}}">
    </form>

    <!-- Hidden form for VNPAY payment -->
    <form id="vnpayForm" action="{{ url_for('vnpay_payment') }}" method="POST" style="display: none;">
      <input type="hidden" name="CustomerName" id="vnpay_customer_name">
      <input type="hidden" name="CustomerEmail" id="vnpay_customer_email">
      <input type="hidden" name="CustomerPhone" id="vnpay_customer_phone">
      <input type="hidden" name="CustomerAddress" id="vnpay_customer_address">
      <input type="hidden" name="amount" value="{{(subtotals-discounttotal)}}">
    </form>
    {% endif %}
  </div>
</div>

<style>
  .cart-item:hover {
    background-color: #f8f9fa;
    transition: background-color 0.3s ease;
    border-radius: 8px;
    margin: 2px 0;
  }

  .product-image-wrapper {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .product-image-wrapper img {
    transition: transform 0.3s ease;
    width: 100%;
    height: 100px;
    object-fit: cover;
  }

  .product-image-wrapper:hover img {
    transform: scale(1.05);
  }

  .product-title a:hover {
    color: #007bff !important;
  }

  .product-title {
    font-size: 1.4rem;
    font-weight: 600;
  }

  .summary-item {
    padding: 12px 16px;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .summary-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .btn {
    border-radius: 8px;
    transition: all 0.3s ease;
    font-weight: 500;
  }

  .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .card {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .card-header {
    padding: 1rem 1.5rem;
    font-weight: 600;
  }

  .card-header h4,
  .card-header h5 {
    font-size: 1.25rem;
    margin: 0;
  }

  .form-select,
  .form-control {
    border-radius: 6px;
    border: 1px solid #dee2e6;
    padding: 6px 10px;
    font-size: 14px;
  }

  /* Smaller input fields for customer info */
  #customer_name, #customer_email, #customer_phone {
    padding: 4px 8px;
    font-size: 13px;
    height: 32px;
  }

  .form-select:focus,
  .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }

  .breadcrumb {
    background: transparent;
    padding: 0;
    margin-bottom: 2rem;
  }

  .breadcrumb-item a {
    color: #007bff;
    text-decoration: none;
    font-weight: 500;
  }

  .breadcrumb-item.active {
    color: #6c757d;
    font-weight: 600;
  }

  .price-section {
    text-align: right;
  }

  .current-price {
    font-size: 1.25rem;
    color: #28a745 !important;
  }

  .original-price {
    font-size: 0.875rem;
  }

  .badge {
    font-size: 0.75rem;
    padding: 4px 8px;
  }

  .cart-item {
    border-bottom: 1px solid #e9ecef;
    padding: 20px;
  }

  .cart-item:last-child {
    border-bottom: none;
  }

  /* Order Summary Styling */
  .summary-item {
    padding: 16px 20px;
    border-radius: 10px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .summary-item.bg-primary {
    background: linear-gradient(135deg, #0cafe5 0%, #0ba5d4 100%) !important;
    border: none;
    box-shadow: 0 4px 12px rgba(12, 175, 229, 0.3);
  }

  .summary-item.bg-light {
    background-color: #ffffff !important;
    border: 1px solid #e9ecef;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }

  .summary-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .form-check-input:checked {
    background-color: #0cafe5;
    border-color: #0cafe5;
  }

  .form-check-label {
    cursor: pointer;
    font-weight: 500;
  }

  .form-check-label:hover {
    color: #0cafe5;
  }
</style>

<script>
  function placeOrder() {
    // Get customer information
    var customerName = document.getElementById('customer_name').value;
    var customerEmail = document.getElementById('customer_email').value;
    var customerPhone = document.getElementById('customer_phone').value;
    var customerAddress = document.getElementById('customer_address').value;
    
    // Get payment method
    var paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
    
    // Validate required fields
    if (!customerAddress.trim()) {
      alert('Vui lòng nhập địa chỉ giao hàng!');
      document.getElementById('customer_address').focus();
      return;
    }
    
    // Confirm order
    var confirmMessage = "Bạn có chắc chắn muốn đặt hàng?\n\n";
    confirmMessage += "Thông tin đặt hàng:\n";
    confirmMessage += "- Họ tên: " + customerName + "\n";
    confirmMessage += "- Email: " + customerEmail + "\n";
    confirmMessage += "- Số điện thoại: " + customerPhone + "\n";
    confirmMessage += "- Địa chỉ: " + customerAddress + "\n";
    confirmMessage += "- Phương thức thanh toán: " + (paymentMethod === 'cod' ? 'Thanh toán khi nhận hàng' : 'Thanh toán VNPAY');
    
    if (!confirm(confirmMessage)) {
      return;
    }
    
    // Fill hidden forms
    document.getElementById('form_customer_name').value = customerName;
    document.getElementById('form_customer_email').value = customerEmail;
    document.getElementById('form_customer_phone').value = customerPhone;
    document.getElementById('form_customer_address').value = customerAddress;
    document.getElementById('form_payment_method').value = paymentMethod;
    
    document.getElementById('vnpay_customer_name').value = customerName;
    document.getElementById('vnpay_customer_email').value = customerEmail;
    document.getElementById('vnpay_customer_phone').value = customerPhone;
    document.getElementById('vnpay_customer_address').value = customerAddress;
    
    // Submit based on payment method
    if (paymentMethod === 'cod') {
      document.getElementById('orderForm').submit();
    } else if (paymentMethod === 'vnpay') {
      document.getElementById('vnpayForm').submit();
    }
  }
  
  // Add click handlers for radio buttons
  document.addEventListener('DOMContentLoaded', function() {
    var radioButtons = document.querySelectorAll('input[name="payment_method"]');
    radioButtons.forEach(function(radio) {
      radio.addEventListener('change', function() {
        // You can add any additional logic here when payment method changes
        console.log('Payment method changed to:', this.value);
      });
    });
  });
</script>

{% include 'footer.html' %} {% endblock content%}
