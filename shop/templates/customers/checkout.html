{% extends "base.html" %}
{% block content%}
{% include 'header.html' %}

<style>
.checkout-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f8f9fa;
    min-height: 100vh;
}

.checkout-content {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 30px;
    align-items: start;
}

.checkout-form-section {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    padding: 30px;
}

.checkout-summary {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    border-top: 4px solid #0cafe5;
    overflow: hidden;
    position: sticky;
    top: 20px;
}

.checkout-summary h3 {
    background: #0cafe5;
    color: white;
    margin: 0;
    padding: 15px 20px;
    font-size: 16px;
    font-weight: 600;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #495057;
}

.form-group input[type="text"],
.form-group textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s ease;
}

.form-group input[type="text"]:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #667eea;
}

.delivery-options {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.delivery-option {
    flex: 1;
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.delivery-option:hover {
    border-color: #667eea;
}

.delivery-option.selected {
    border-color: #667eea;
    background-color: #f8f9ff;
}

.delivery-option h4 {
    margin: 0 0 8px 0;
    color: #495057;
}

.delivery-option p {
    margin: 0;
    font-size: 14px;
    color: #6c757d;
}

.radio-group {
    margin: 15px 0;
}

.radio-option {
    display: block;
    margin-bottom: 8px;
}

.radio-option input[type="radio"] {
    margin-right: 8px;
}

.store-info {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    margin-top: 10px;
    border-left: 4px solid #667eea;
}

.store-info h5 {
    margin: 0 0 8px 0;
    color: #495057;
}

.btn-submit {
    background: #0cafe5;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    transition: all 0.3s ease;
}

.btn-submit:hover {
    background: #0a9bc5;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(12, 175, 229, 0.3);
}

.btn-submit:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
}

.product-summary {
    padding: 20px;
}

.product-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #e9ecef;
}

.product-item:last-child {
    border-bottom: none;
}

.product-info {
    flex: 1;
}

.product-price {
    font-weight: 600;
    color: #495057;
}

.total-section {
    border-top: 2px solid #e9ecef;
    padding-top: 15px;
    margin-top: 15px;
}

.total-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}

.total-row.final {
    font-size: 18px;
    font-weight: 700;
    color: #667eea;
    border-top: 1px solid #e9ecef;
    padding-top: 10px;
}

.alert {
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.alert-danger {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.alert-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-info {
    background-color: #cce5ff;
    border: 1px solid #99d6ff;
    color: #004085;
}
</style>

<div class="checkout-container">
    <h1 style="text-align: center; color: #495057; margin-bottom: 30px;">Thanh to√°n ƒë∆°n h√†ng</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" id="checkout-form">
        {{ form.hidden_tag() }}

        <div class="checkout-content">
            <!-- Form Section -->
            <div class="checkout-form-section">
                <h2 style="margin-bottom: 25px; color: #495057;">Th√¥ng tin giao h√†ng</h2>

                <!-- Delivery Method Selection -->
                <div class="form-group">
                    <label>{{ form.delivery_method.label }}</label>
                    <div class="delivery-options">
                        <div class="delivery-option" data-method="home_delivery">
                            <input type="radio" name="delivery_method" value="home_delivery" style="display: none;" {{ 'checked' if form.delivery_method.data == 'home_delivery' else '' }}>
                            <h4>üöö Giao t·∫≠n nh√†</h4>
                            <p>Giao h√†ng ƒë·∫øn ƒë·ªãa ch·ªâ c·ªßa b·∫°n trong 2-3 ng√†y l√†m vi·ªác</p>
                        </div>
                        <div class="delivery-option" data-method="instore_pickup">
                            <input type="radio" name="delivery_method" value="instore_pickup" style="display: none;" {{ 'checked' if form.delivery_method.data == 'instore_pickup' else '' }}>
                            <h4>üè™ Nh·∫≠n t·∫°i c·ª≠a h√†ng</h4>
                            <p>ƒê·∫øn c·ª≠a h√†ng Belluni ƒë·ªÉ nh·∫≠n h√†ng trong 1-2 ng√†y l√†m vi·ªác</p>
                        </div>
                    </div>
                </div>

                <!-- Address Field (for home delivery) -->
                <div class="form-group" id="address-group" style="{{ 'display: block;' if form.delivery_method.data == 'home_delivery' else 'display: none;' }}">
                    <label for="customer_address">{{ form.customer_address.label }} <small style="color: #6c757d;">(t√πy ch·ªçn)</small></label>
                    {{ form.customer_address(class="form-control", rows="3") }}
                    {% if form.customer_address.errors %}
                        {% for error in form.customer_address.errors %}
                            <small style="color: #dc3545;">{{ error }}</small>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- Store Selection (for pickup) -->
                <div class="form-group" id="store-group" style="{{ 'display: block;' if form.delivery_method.data == 'instore_pickup' else 'display: none;' }}">
                    <label>{{ form.pickup_store.label }}</label>
                    <div class="radio-group">
                        {% for subfield in form.pickup_store %}
                            <label class="radio-option">
                                {{ subfield }}
                                {{ subfield.label.text }}
                            </label>
                        {% endfor %}
                    </div>

                    <div class="store-info" id="store-info">
                        <h5>üìç Th√¥ng tin c·ª≠a h√†ng Belluni C·∫ßu Di·ªÖn</h5>
                        <p><strong>ƒê·ªãa ch·ªâ:</strong> S·ªë 298 ƒê. C·∫ßu Di·ªÖn, Minh Khai, B·∫Øc T·ª´ Li√™m, H√† N·ªôi</p>
                        <p><strong>Gi·ªù m·ªü c·ª≠a:</strong> 9:00 - 21:00 (t·∫•t c·∫£ c√°c ng√†y trong tu·∫ßn)</p>
                        <p><strong>Hotline:</strong> 0033.219.4677</p>
                        <p><strong>Email:</strong> VietHoang@gmail.com</p>
                    </div>
                </div>

                <!-- Payment Method Selection -->
                <div class="form-group">
                    <label>{{ form.payment_method.label }}</label>
                    <div class="radio-group">
                        {% for subfield in form.payment_method %}
                            <label class="radio-option">
                                {{ subfield }}
                                {{ subfield.label.text }}
                            </label>
                        {% endfor %}
                    </div>

                    <div class="payment-info" id="payment-info">
                        <div id="cod-info" style="display: {{ 'block' if form.payment_method.data == 'cod' else 'none' }};">
                            <div class="alert alert-info">
                                <h6>üí∞ Thanh to√°n khi nh·∫≠n h√†ng (COD)</h6>
                                <p>‚Ä¢ Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng t·∫°i nh√† ho·∫∑c t·∫°i c·ª≠a h√†ng</p>
                                <p>‚Ä¢ Mi·ªÖn ph√≠ giao h√†ng cho ƒë∆°n t·ª´ 500.000‚Ç´ tr·ªü l√™n</p>
                                <p>‚Ä¢ Ph√≠ giao h√†ng: 30.000‚Ç´ cho ƒë∆°n d∆∞·ªõi 500.000‚Ç´</p>
                            </div>
                        </div>

                        <div id="vnpay-info" style="display: {{ 'block' if form.payment_method.data == 'vnpay' else 'none' }};">
                            <div class="alert alert-success">
                                <h6>üí≥ Thanh to√°n online (VNPAY)</h6>
                                <p>‚Ä¢ Thanh to√°n an to√†n qua c·ªïng VNPAY</p>
                                <p>‚Ä¢ H·ªó tr·ª£ nhi·ªÅu ng√¢n h√†ng v√† v√≠ ƒëi·ªán t·ª≠</p>
                                <p>‚Ä¢ X·ª≠ l√Ω giao d·ªãch t·ª©c th√¨</p>
                            </div>
                        </div>
                    </div>

                    {% if form.payment_method.errors %}
                        {% for error in form.payment_method.errors %}
                            <small style="color: #dc3545;">{{ error }}</small>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- Payment Info -->
                <div class="form-group">
                    <div class="alert alert-info">
                        <h5>üí≥ Th√¥ng tin thanh to√°n</h5>
                        <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> Thanh to√°n khi nh·∫≠n h√†ng (COD)</p>
                        <p><strong>Ph√≠ giao h√†ng:</strong> Mi·ªÖn ph√≠ cho ƒë∆°n h√†ng t·ª´ 500.000‚Ç´ tr·ªü l√™n</p>
                        <p><strong>Th·ªùi gian x·ª≠ l√Ω:</strong> 1-2 ng√†y l√†m vi·ªác</p>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn-submit" {{ 'disabled' if not session.get('Shoppingcart') }}>
                    üõí ƒê·∫∑t h√†ng ngay
                </button>
            </div>

            <!-- Order Summary -->
            <div class="checkout-summary">
                <h3>üìã T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
                <div class="product-summary">
                    {% if session.get('Shoppingcart') %}
                        {% for key, item in session.Shoppingcart.items() %}
                            <div class="product-item">
                                <div class="product-info">
                                    <div style="font-weight: 600;">{{ item.name }}</div>
                                    <div style="color: #6c757d; font-size: 14px;">
                                        S·ªë l∆∞·ª£ng: {{ item.quantity }}
                                        {% if item.colors %} | M√†u: {{ item.colors }}{% endif %}
                                    </div>
                                </div>
                                <div class="product-price">
                                    {{ ((item.price | float) * (item.quantity | int)) | vnd }}
                                </div>
                            </div>
                        {% endfor %}

                        <div class="total-section">
                            <div class="total-row">
                                <span>T·∫°m t√≠nh:</span>
                                <span>{{ subtotal | vnd }}</span>
                            </div>
                            {% if discount > 0 %}
                                <div class="total-row">
                                    <span>Gi·∫£m gi√°:</span>
                                    <span style="color: #dc3545;">-{{ discount | vnd }}</span>
                                </div>
                            {% endif %}
                            <div class="total-row final">
                                <span>T·ªïng c·ªông:</span>
                                <span>{{ total | vnd }}</span>
                            </div>
                        </div>
                    {% else %}
                        <p style="text-align: center; color: #6c757d; padding: 20px;">
                            Gi·ªè h√†ng tr·ªëng. <a href="{{ url_for('home') }}">Ti·∫øp t·ª•c mua s·∫Øm</a>
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const deliveryOptions = document.querySelectorAll('.delivery-option');
    const addressGroup = document.getElementById('address-group');
    const storeGroup = document.getElementById('store-group');
    const radioInputs = document.querySelectorAll('input[name="delivery_method"]');

    // Payment method handling
    const paymentMethodInputs = document.querySelectorAll('input[name="payment_method"]');
    const codInfo = document.getElementById('cod-info');
    const vnpayInfo = document.getElementById('vnpay-info');

    // Delivery method handling
    deliveryOptions.forEach(option => {
        option.addEventListener('click', function() {
            const method = this.dataset.method;

            // Update visual selection
            deliveryOptions.forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');

            // Update radio button
            radioInputs.forEach(radio => {
                radio.checked = radio.value === method;
            });

            // Show/hide relevant fields
            if (method === 'home_delivery') {
                addressGroup.style.display = 'block';
                storeGroup.style.display = 'none';
            } else {
                addressGroup.style.display = 'none';
                storeGroup.style.display = 'block';
            }
        });
    });

    // Payment method handling
    paymentMethodInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.value === 'cod') {
                codInfo.style.display = 'block';
                vnpayInfo.style.display = 'none';
            } else if (this.value === 'vnpay') {
                codInfo.style.display = 'none';
                vnpayInfo.style.display = 'block';
            }
        });
    });

    // Set initial states
    const initialDeliveryMethod = document.querySelector('input[name="delivery_method"]:checked');
    if (initialDeliveryMethod) {
        document.querySelector(`[data-method="${initialDeliveryMethod.value}"]`).classList.add('selected');
    }

    const initialPaymentMethod = document.querySelector('input[name="payment_method"]:checked');
    if (initialPaymentMethod) {
        if (initialPaymentMethod.value === 'cod') {
            codInfo.style.display = 'block';
            vnpayInfo.style.display = 'none';
        } else if (initialPaymentMethod.value === 'vnpay') {
            codInfo.style.display = 'none';
            vnpayInfo.style.display = 'block';
        }
    }
});
</script>

{% include 'footer.html' %}
{% endblock %}
